{% extends 'base.html' %}
{% block title%}Cattle Records{% endblock %}
{% block content %}
<div class="container-fluid">
    <table class=table>
        </tr>
        <th>Cow</th>
        <th>Born</th>
        <th>Owner</th>
        <th>Report</th>
        <th>Add Event</th>
        <th>Delete Cow</th>
        </tr>
        {% for cow in cows_table %}
        <tr>
            <td class="w-25">
                <h7>{{ cow.cow }}<h7>
            </td>
            <td>
                <h7>{{ cow.born }}<h7>
            </td>
            <td>
                <h7>{{ cow.owner }}<h7>
            </td>
            <td><button class="btn btn-primary" data-toggle="modal" data-target="#reportModal"
                    onclick="generateReport('{{ cow.uuid }}')">View Report</button>
            </td>
            <td><button class="btn btn-success" data-toggle="modal" data-target="#newEventModal">Add Event</button>
            </td>
            <td><button class="btn btn-danger" data-toggle="modal" data-target="#deleteCowModal">Delete Cow</button>
            </td>
        </tr>
        {% endfor %}
    </table>
    <button class="m-2 btn btn-success" data-toggle="modal" data-target="#newCowModal">Add Cow</button>
    <!-- Modal -->
    <div class="modal fade" id="reportModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">View Report</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <ul class="mb-3 nav nav-tabs" id="myTab" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="events-tab" data-toggle="tab" href="#events" role="tab"
                                aria-controls="home" aria-selected="true">Events</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="finances-tab" data-toggle="tab" href="#finances" role="tab"
                                aria-controls="profile" aria-selected="false">Finances</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="something-else-tab" data-toggle="tab" href="#something-else"
                                role="tab" aria-controls="contact" aria-selected="false">Something Else</a>
                        </li>
                    </ul>
                    <div class="tab-content" id="myTabContent">
                        <div class="tab-pane fade show active" id="events" role="tabpanel" aria-labelledby="events-tab">
                            <div class=container>
                                <h5 id="reportEventsCowNumber">123:</h5>
                                <table id="reportEventTable" class="table">
                                </table>
                                <button class="btn btn-success" data-toggle="modal" data-target="#newEventModal">Add
                                    Event</button>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="finances" role="tabpanel" aria-labelledby="profile-tab">
                            <div class=container>
                                <h5 id="reportFinancesCowNumber">123:</h5>
                                <table id="reportFinanceTable" class="table">
                                  
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="something-else" role="tabpanel" aria-labelledby="contact-tab">
                            <div class=container>
                                <p>I'm not sure where else to put here...</p>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="newCowModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Add Cow</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <select class="form-control">
                        <option>Option 1</option>
                        <option>Option 2</option>
                        <option>Option 3</option>
                        <option>Option 4</option>
                    </select>
                    <input class="form-control" placeholder="Some Text" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Add</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="newEventModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Add Event</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <select class="form-control">
                        <option>Option 1</option>
                        <option>Option 2</option>
                        <option>Option 3</option>
                        <option>Option 4</option>
                    </select>
                    <input class="form-control" placeholder="Some Text" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Add</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="deleteCowModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Delete Cow</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete "INSERT COW NUMBER HERE"?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger">Delete</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block js %}
<script>
    function generateReport(uuid) {
        cow = getCow(uuid);
        document.getElementById("reportEventsCowNumber").innerHTML = cow.Number + ":"; 
        document.getElementById("reportFinancesCowNumber").innerHTML = cow.Number + ":";
        
        //Events
        var eventTable = document.getElementById("reportEventTable")

        var eventTableString = `
        <tr>
            <th>Event</th>
            <th>Date</th>
        </tr>
        `;
        console.log()
        for (var i = 0; i < cow.Events.length; i++) {
            eventTableString += `
            <tr>
                <td>` + cow.Events[i][0] + `</td>
                <td>` + cow.Events[i][1]+ `</td>
                <td data-toggle="tooltip" data-placement="bottom" title="This event has a transaction">` + (cow.Events[i][2] ? "$" : "") + `</td>
            </tr>
            `;


        }
        eventTable.innerHTML = eventTableString;

        //Finances
        var financeTable = document.getElementById("reportFinanceTable")

        var total = 0;
        var financeTableString = `
        <tr>
            <th>Transaction</th>
            <th>Amount</th>
            <th>Date</th>
        </tr>
        `;
        
        for (var i = 0; i < cow.Events.length; i++) {
            var transactionList = cow.Events[i][2];
            if (transactionList){
                for (var j = 0; j <transactionList.length; j++){
                    financeTableString += `<tr>
                        <td>` + transactionList[j][0] + `</td>
                        <td ` + (transactionList[j][1] == "-" ? 'class="text-danger"' : 'class="text-success"') + ">" + transactionList[j][2] + `</td>
                        <td>` + cow.Events[i][1] + `</td>
                    <tr>`; 
                    total += parseFloat(transactionList[j][1]+transactionList[j][2])
                }
            }
        }
        financeTableString += `
        <tr>
            <td>Total</td>
            <td class="`+ (total >= 0 ? "text-success" : "text-danger" ) + '">' + Math.abs(Math.ceil(total * 100) / 100) +`</td>
        </tr>`
        financeTable.innerHTML = financeTableString;
    }
    function getCow(uuid) {
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.open("GET", "/getcow?cow=" + uuid, false); // true for asynchronous 
        xmlHttp.send(null);
        return JSON.parse(xmlHttp.responseText);
    }
</script>
{% endblock %}